<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MVC ë©€í‹°í”Œë ˆì´ì–´ ëª¬ìŠ¤í„° í”¼í•˜ê¸°</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        background: linear-gradient(135deg, #0c1445, #1a237e);
        font-family: 'Courier New', monospace;
        color: #00ff00;
        overflow: hidden;
        height: 100vh;
      }

      .game-container {
        position: relative;
        width: 100vw;
        height: 100vh;
      }

      #gameCanvas {
        background: radial-gradient(circle at center, #000428, #004e92);
        border: 2px solid #00ff41;
        display: block;
        margin: 0 auto;
      }

      .ui {
        position: absolute;
        top: 10px;
        left: 10px;
        z-index: 10;
        background: rgba(0, 0, 0, 0.8);
        padding: 10px;
        border-radius: 5px;
        border: 1px solid #00ff41;
      }

      .player-list {
        position: absolute;
        top: 10px;
        right: 10px;
        z-index: 10;
        background: rgba(0, 0, 0, 0.8);
        padding: 10px;
        border-radius: 5px;
        border: 1px solid #00ff41;
        min-width: 200px;
      }

      .join-form {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(0, 0, 0, 0.9);
        padding: 30px;
        border-radius: 10px;
        border: 2px solid #00ff41;
        text-align: center;
        z-index: 20;
      }

      input[type='text'] {
        background: rgba(0, 0, 0, 0.7);
        border: 1px solid #00ff41;
        color: #00ff00;
        padding: 10px;
        margin: 10px;
        border-radius: 5px;
        font-family: inherit;
      }

      button {
        background: linear-gradient(45deg, #004e92, #000428);
        border: 2px solid #00ff41;
        color: #00ff00;
        padding: 10px 20px;
        cursor: pointer;
        border-radius: 5px;
        font-family: inherit;
        margin: 5px;
        transition: all 0.3s;
      }

      button:hover {
        background: linear-gradient(45deg, #006bb3, #001845);
        box-shadow: 0 0 10px #00ff41;
      }

      .game-over {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(30, 30, 30, 0.7);
        display: none;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 15;
        text-align: center;
        color: #ff4444;
      }

      .game-over h2 {
        font-size: 48px;
        text-shadow: 0 0 10px #ff0000;
      }

      .game-over p {
        font-size: 24px;
        margin-bottom: 100px;
      }

      .respawn-button {
        position: absolute;
        bottom: 40px;
        left: 50%;
        transform: translateX(-50%);
        padding: 15px 30px;
        font-size: 18px;
        background: linear-gradient(45deg, #ff4444, #b30000);
        border: 2px solid #ff8888;
        color: #ffffff;
      }

      .instructions {
        position: absolute;
        bottom: 10px;
        left: 10px;
        background: rgba(0, 0, 0, 0.8);
        padding: 10px;
        border-radius: 5px;
        border: 1px solid #00ff41;
        font-size: 12px;
      }

      .test-panel {
        position: absolute;
        bottom: 10px;
        right: 10px;
        background: rgba(0, 0, 0, 0.8);
        padding: 10px;
        border-radius: 5px;
        border: 1px solid #ffaa00;
        font-size: 10px;
        color: #ffaa00;
        max-width: 300px;
        max-height: 200px;
        overflow-y: auto;
        z-index: 1000; /* High z-index to ensure visibility */
      }

      .debug-panel {
        position: absolute;
        top: 10px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0, 0, 0, 0.8);
        padding: 10px;
        border-radius: 5px;
        border: 1px solid #ff00ff;
        font-size: 10px;
        color: #ff00ff;
        display: none;
      }

      .loading {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: #00ff00;
        font-size: 18px;
        z-index: 30;
        display: none;
      }

      .error-message {
        position: absolute;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(255, 0, 0, 0.8);
        color: white;
        padding: 10px 20px;
        border-radius: 5px;
        display: none;
        z-index: 25;
      }

      .success-message {
        position: absolute;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0, 255, 0, 0.8);
        color: black;
        padding: 10px 20px;
        border-radius: 5px;
        display: none;
        z-index: 25;
      }

      .controls-help {
        position: absolute;
        bottom: 50px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0, 0, 0, 0.8);
        padding: 15px;
        border-radius: 5px;
        border: 1px solid #00ff41;
        text-align: center;
        font-size: 12px;
        display: none;
      }

      .room-link-panel {
        position: absolute;
        top: 50px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0, 0, 0, 0.9);
        padding: 20px;
        border-radius: 10px;
        border: 2px solid #00ff41;
        text-align: center;
        z-index: 22;
        display: none;
        min-width: 500px;
      }

      .room-link-input {
        width: 100%;
        margin: 10px 0;
        padding: 8px;
        background: rgba(0, 0, 0, 0.7);
        border: 1px solid #00ff41;
        color: #00ff00;
        border-radius: 3px;
        font-family: inherit;
        font-size: 12px;
      }

      .realtime-test-popup-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 10000; /* Ensure it's on top */
      }

      .realtime-test-popup-content {
        background: #1a237e;
        border: 2px solid #00ff41;
        border-radius: 10px;
        padding: 20px;
        width: 90%;
        max-width: 600px;
        max-height: 80%;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
      }

      .realtime-test-results-list {
        flex-grow: 1;
        margin-top: 10px;
        padding-right: 10px;
        font-size: 12px;
        color: #00ff00;
      }

      .realtime-test-results-list div {
        margin-bottom: 2px;
      }

      .realtime-test-summary {
        margin-top: 15px;
        padding-top: 10px;
        border-top: 1px solid #004e92;
        font-size: 14px;
        color: #00ff00;
        text-align: right;
      }

      .realtime-test-popup-close-btn {
        margin-top: 20px;
        align-self: flex-end;
      }

      @media (max-width: 768px) {
        .join-form {
          width: 90%;
          padding: 20px;
        }

        .room-link-panel {
          width: 90%;
          min-width: auto;
        }

        .player-list {
          top: auto;
          bottom: 10px;
          right: 10px;
          font-size: 10px;
          min-width: 150px;
        }

        .test-panel {
          max-width: 200px;
          font-size: 8px;
        }
      }
    </style>
  </head>
  <body>
    <div class="game-container">
      <!-- ë¡œë”© í™”ë©´ -->
      <div class="loading" id="loading">ğŸ® ê²Œì„ ë¡œë”© ì¤‘...</div>

      <!-- ì˜¤ë¥˜ ë©”ì‹œì§€ -->
      <div class="error-message" id="errorMessage"></div>

      <!-- ì„±ê³µ ë©”ì‹œì§€ -->
      <div class="success-message" id="successMessage"></div>

      <!-- ê²Œì„ ì°¸ê°€ í¼ -->
      <div class="join-form" id="joinForm">
        <h2>ëª¬ìŠ¤í„°ë¥¼ í”¼í•´ë¼!</h2>
        <p>ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”</p>
        <input type="text" id="playerName" placeholder="ë‹‰ë„¤ì„" maxlength="15" />
        <br />
        <button id="joinGameBtn">ê²Œì„ ì°¸ê°€</button>
        <button id="runTestsBtn">ğŸ§ª í…ŒìŠ¤íŠ¸ ì‹¤í–‰</button>
        <button id="showControlsBtn">ğŸ® ì¡°ì‘ë²•</button>
        <div style="margin-top: 15px; font-size: 12px; color: #888">
          âœ¨ MVC íŒ¨í„´ìœ¼ë¡œ ë¦¬íŒ©í† ë§ëœ ê²Œì„<br />
          ğŸ§ª í…ŒìŠ¤íŠ¸ ê°€ëŠ¥í•œ êµ¬ì¡°ë¡œ ì„¤ê³„<br />
          ğŸ”— BroadcastChannel APIë¡œ ì‹¤ì‹œê°„ ë™ê¸°í™”<br />
          ğŸ® í˜„ì¬ ìƒíƒœ: <span id="connectionStatus">ì—°ê²° ëŒ€ê¸° ì¤‘...</span>
        </div>
      </div>

      <!-- ê²Œì„ UI -->
      <div class="ui" id="gameUI" style="display: none">
        <div>â±ï¸ ìƒì¡´ ì‹œê°„: <span id="timeDisplay">0</span>ì´ˆ</div>
        <div>ğŸ‘¾ ëª¬ìŠ¤í„° ìˆ˜: <span id="observerCount">0</span></div>
        <div>ğŸ† ë‚´ ì ìˆ˜: <span id="myScore">0</span></div>
        <div>ğŸ“Š FPS: <span id="fpsDisplay">60</span></div>
        <div id="levelControl" style="display: none; margin-top: 10px">
          <div>ğŸšï¸ ë ˆë²¨: <span id="levelDisplay">1</span></div>
          <button id="levelDownBtn">-</button>
          <button id="levelUpBtn">+</button>
        </div>
      </div>

      <!-- í”Œë ˆì´ì–´ ëª©ë¡ -->
      <div class="player-list" id="playerList" style="display: none">
        <h3>ğŸ‘¥ í”Œë ˆì´ì–´ ëª©ë¡</h3>
        <div id="players"></div>
      </div>

      <!-- ê²Œì„ ìº”ë²„ìŠ¤ -->
      <canvas id="gameCanvas" style="display: none"></canvas>

      <!-- ê²Œì„ ì˜¤ë²„ í™”ë©´ -->
      <div class="game-over" id="gameOver">
        <h2>ğŸ’€ GAME OVER</h2>
        <p id="finalScore"></p>
        <button class="respawn-button" id="respawnBtn">ğŸ”„ ë‹¤ì‹œ ì‹œì‘</button>
      </div>

      <!-- ê²Œì„ ì¡°ì‘ë²• -->
      <div class="instructions" id="instructions" style="display: none">
        âŒ¨ï¸ í™”ì‚´í‘œ í‚¤ ë˜ëŠ” WASDë¡œ ì´ë™ â€¢ ğŸ”« ìŠ¤í˜ì´ìŠ¤ë°”ë¡œ ì´ ë°œì‚¬ â€¢ ğŸ‘¾ ëª¬ìŠ¤í„°ë¥¼ í”¼í•˜ì„¸ìš”! â€¢ ğŸ’¥ ë‹¤ë¥¸ í”Œë ˆì´ì–´ì™€ ë¶€ë”ªíˆë©´
        ê¸°ì ˆ!
      </div>

      <!-- ì¡°ì‘ë²• ë„ì›€ë§ -->
      <div class="controls-help" id="controlsHelp">
        <h3>ğŸ® ê²Œì„ ì¡°ì‘ë²•</h3>
        <p><strong>ì´ë™:</strong> â¬†ï¸â¬‡ï¸â¬…ï¸â¡ï¸ í™”ì‚´í‘œ í‚¤ ë˜ëŠ” W A S D</p>
        <p><strong>ê³µê²©:</strong> ğŸ”« ìŠ¤í˜ì´ìŠ¤ë°” (ìë™ ì¡°ì¤€)</p>
        <p><strong>ëª©í‘œ:</strong> ğŸ‘¾ ëª¬ìŠ¤í„°ë¥¼ í”¼í•˜ê³  ìµœëŒ€í•œ ì˜¤ë˜ ìƒì¡´í•˜ì„¸ìš”!</p>
        <p><strong>ë ˆë²¨ì—…:</strong> ğŸ† ì ìˆ˜ê°€ ì˜¬ë¼ê°ˆìˆ˜ë¡ ë” ê°•í•´ì§‘ë‹ˆë‹¤</p>
        <p><strong>ë©€í‹°í”Œë ˆì´ì–´:</strong> ğŸ”— ë§í¬ë¥¼ ê³µìœ í•´ì„œ ì¹œêµ¬ë“¤ê³¼ í•¨ê»˜ í”Œë ˆì´í•˜ì„¸ìš”</p>
        <br />
        <button id="hideControlsBtn">ë‹«ê¸°</button>
      </div>

      <!-- ë°© ë§í¬ ê³µìœ  -->
      <div class="room-link-panel" id="roomLinkPanel">
        <h3>ğŸ”— ì¹œêµ¬ ì´ˆëŒ€í•˜ê¸°</h3>
        <p>ì´ ë§í¬ë¥¼ ì¹œêµ¬ë“¤ì—ê²Œ ê³µìœ í•˜ì„¸ìš”:</p>
        <input type="text" class="room-link-input" id="roomLinkInput" readonly />
        <br />
        <button id="copyRoomLinkBtn">ğŸ“‹ ë§í¬ ë³µì‚¬</button>
        <button id="hideRoomLinkBtn">ë‹«ê¸°</button>
        <div style="margin-top: 15px; font-size: 10px; color: #888">
          ğŸ’¡ ë§í¬ë¥¼ ë³µì‚¬í•´ì„œ ì¹œêµ¬ë“¤ì—ê²Œ ë³´ë‚´ì£¼ì„¸ìš”!<br />
          ğŸŒ ê°™ì€ ë¸Œë¼ìš°ì €ì—ì„œ ìƒˆ íƒ­ì„ ì—´ì–´ì„œ í…ŒìŠ¤íŠ¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
        </div>
      </div>

      <!-- ë¦¬ì…‹ ë²„íŠ¼ -->
      <div
        id="resetContainer"
        style="position: absolute; top: 10px; left: 50%; transform: translateX(-50%); z-index: 20; display: none"
      >
        <button id="resetGameBtn">ğŸ”„ ëª¨ë“  ëª¬ìŠ¤í„° ë¦¬ì…‹</button>
      </div>

      <!-- í…ŒìŠ¤íŠ¸ ê²°ê³¼ íŒ¨ë„ -->
      <div class="test-panel" id="testPanel" style="display: none">
        <h4>ğŸ§ª í…ŒìŠ¤íŠ¸ ê²°ê³¼</h4>
        <div id="testResults"></div>
        <button
          id="hideTestPanelBtn"
          style="margin-top: 5px; font-size: 8px"
          onclick="window.game.view.hideTestPanel()"
        >
          ë‹«ê¸°
        </button>
      </div>

      <!-- Realtime Test Popup -->
      <div class="realtime-test-popup-overlay" id="realtimeTestPopupOverlay" style="display: none">
        <div class="realtime-test-popup-content">
          <h3 style="color: #00ff00">ğŸ§ª ì‹¤ì‹œê°„ í…ŒìŠ¤íŠ¸ ê²°ê³¼</h3>
          <div id="realtimeTestResultsList" class="realtime-test-results-list">
            <!-- Realtime results will be appended here -->
          </div>
          <div class="realtime-test-summary" id="realtimeTestSummary"></div>
          <button id="closeRealtimeTestPopupBtn" class="realtime-test-popup-close-btn">ë‹«ê¸°</button>
        </div>
      </div>

      <!-- ë””ë²„ê·¸ íŒ¨ë„ -->
      <div class="debug-panel" id="debugPanel">
        <h4>ğŸ› ë””ë²„ê·¸ ì •ë³´</h4>
        <div id="debugInfo"></div>
      </div>
    </div>

    <!-- ê²Œì„ ìŠ¤í¬ë¦½íŠ¸ (ES6 ëª¨ë“ˆ) -->
    <script type="module">
      import { GameState } from './js/model.js';
      import { GameView } from './js/view.js';
      import { GameController } from './js/controller.js';
      import { NetworkService } from './js/network.js';
      import { TestFramework } from './js/test-framework.js';
      import { setupGameTests } from './js/tests.js';

      // í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ ì‹œ ì´ˆê¸°í™”
      document.addEventListener('DOMContentLoaded', () => {
        // ì „ì—­ ê²Œì„ ì¸ìŠ¤í„´ìŠ¤ë“¤
        const gameState = new GameState();
        const gameView = new GameView();
        const networkService = new NetworkService();
        const testFramework = new TestFramework();
        const gameController = new GameController(gameState, gameView, networkService, testFramework);

        // í…ŒìŠ¤íŠ¸ ì„¤ì •
        setupGameTests(testFramework);

        // FPS ì¹´ìš´í„°
        let lastFrameTime = Date.now();
        let frameCount = 0;
        let fps = 60;

        function updateFPS() {
          frameCount++;
          const now = Date.now();

          if (now - lastFrameTime >= 1000) {
            fps = Math.round((frameCount * 1000) / (now - lastFrameTime));
            frameCount = 0;
            lastFrameTime = now;

            const fpsDisplay = document.getElementById('fpsDisplay');
            if (fpsDisplay) {
              fpsDisplay.textContent = fps;
              fpsDisplay.style.color = fps < 30 ? '#ff4444' : fps < 50 ? '#ffaa00' : '#00ff00';
            }
          }
        }

        // ê²Œì„ ë£¨í”„ì— FPS ì¹´ìš´í„° ì¶”ê°€
        const originalRender = gameView.render.bind(gameView);
        gameView.render = function (gameState) {
          updateFPS();
          return originalRender(gameState);
        };

        // ë””ë²„ê·¸ ëª¨ë“œ í† ê¸€ (Ctrl+D)
        let debugInterval = null;
        document.addEventListener('keydown', (e) => {
          if (e.ctrlKey && e.key === 'd') {
            gameState.debug = !gameState.debug;
            const debugPanel = document.getElementById('debugPanel');
            if (debugPanel) {
              debugPanel.style.display = gameState.debug ? 'block' : 'none';
            }

            if (gameState.debug) {
              if (debugInterval) clearInterval(debugInterval);
              debugInterval = setInterval(updateDebugInfo, 1000);
            } else {
              if (debugInterval) clearInterval(debugInterval);
            }

            e.preventDefault();
          }
        });

        function updateDebugInfo() {
          if (!gameState.debug) return;

          const debugInfo = document.getElementById('debugInfo');
          if (debugInfo) {
            const info = [
              `í”Œë ˆì´ì–´: ${gameState.players.size}`,
              `ëª¬ìŠ¤í„°: ${gameState.monsters.length}`,
              `ì´ì•Œ: ${gameState.bullets.length}`,
              `ì•„ì´í…œ: ${gameState.items.length}`,
              `FPS: ${fps}`,
              `í˜¸ìŠ¤íŠ¸: ${gameState.isHost ? 'Yes' : 'No'}`,
              `ì—°ê²°: ${networkService.isConnected() ? 'Yes' : 'No'}`,
              `ë°© ID: ${gameState.roomId || 'None'}`,
            ];

            debugInfo.innerHTML = info.map((line) => `<div>${line}</div>`).join('');
          }
        }

        // ì „ì—­ ì ‘ê·¼ì„ ìœ„í•œ ê°ì²´ ë…¸ì¶œ (ë””ë²„ê¹…ìš©)
        window.game = {
          state: gameState,
          view: gameView,
          controller: gameController,
          network: networkService,
          tests: testFramework,
        };

        console.log('ğŸ® MVC ë©€í‹°í”Œë ˆì´ì–´ ê²Œì„ ì´ˆê¸°í™” ì™„ë£Œ');
        console.log('ğŸ“ ì‚¬ìš© ê°€ëŠ¥í•œ ëª…ë ¹ì–´:');
        console.log('  - window.game: ê²Œì„ ê°ì²´ ì ‘ê·¼');
        console.log('  - Ctrl+D: ë””ë²„ê·¸ ëª¨ë“œ í† ê¸€');

        // URLì— ë°© IDê°€ ìˆìœ¼ë©´ ìë™ìœ¼ë¡œ ì°¸ê°€ ëª¨ë“œë¡œ ì „í™˜
        const urlParams = new URLSearchParams(window.location.search);
        const roomId = urlParams.get('room');
        if (roomId) {
          const statusElement = document.getElementById('connectionStatus');
          if (statusElement) {
            statusElement.textContent = 'ë°©ì— ì°¸ê°€ ëŒ€ê¸° ì¤‘...';
            statusElement.style.color = '#ffaa00';
          }
        }
      });
    </script>

    <noscript>
      <div
        style="
          position: fixed;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          background: rgba(255, 0, 0, 0.9);
          color: white;
          padding: 20px;
          border-radius: 10px;
          text-align: center;
        "
      >
        <h2>JavaScriptê°€ í•„ìš”í•©ë‹ˆë‹¤</h2>
        <p>ì´ ê²Œì„ì„ í”Œë ˆì´í•˜ë ¤ë©´ JavaScriptë¥¼ í™œì„±í™”í•´ì£¼ì„¸ìš”.</p>
      </div>
    </noscript>
  </body>
</html>
