<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MVC 멀티플레이어 몬스터 피하기</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        background: linear-gradient(135deg, #0c1445, #1a237e);
        font-family: 'Courier New', monospace;
        color: #00ff00;
        overflow: hidden;
        height: 100vh;
      }

      .game-container {
        position: relative;
        width: 100vw;
        height: 100vh;
      }

      #gameCanvas {
        background: radial-gradient(circle at center, #000428, #004e92);
        border: 2px solid #00ff41;
        display: block;
        margin: 0 auto;
      }

      .ui {
        position: absolute;
        top: 10px;
        left: 10px;
        z-index: 10;
        background: rgba(0, 0, 0, 0.8);
        padding: 10px;
        border-radius: 5px;
        border: 1px solid #00ff41;
      }

      .player-list {
        position: absolute;
        top: 10px;
        right: 10px;
        z-index: 10;
        background: rgba(0, 0, 0, 0.8);
        padding: 10px;
        border-radius: 5px;
        border: 1px solid #00ff41;
        min-width: 200px;
      }

      .join-form {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(0, 0, 0, 0.9);
        padding: 30px;
        border-radius: 10px;
        border: 2px solid #00ff41;
        text-align: center;
        z-index: 20;
      }

      input[type='text'] {
        background: rgba(0, 0, 0, 0.7);
        border: 1px solid #00ff41;
        color: #00ff00;
        padding: 10px;
        margin: 10px;
        border-radius: 5px;
        font-family: inherit;
      }

      button {
        background: linear-gradient(45deg, #004e92, #000428);
        border: 2px solid #00ff41;
        color: #00ff00;
        padding: 10px 20px;
        cursor: pointer;
        border-radius: 5px;
        font-family: inherit;
        margin: 5px;
        transition: all 0.3s;
      }

      button:hover {
        background: linear-gradient(45deg, #006bb3, #001845);
        box-shadow: 0 0 10px #00ff41;
      }

      .game-over {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(30, 30, 30, 0.7);
        display: none;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 15;
        text-align: center;
        color: #ff4444;
      }

      .game-over h2 {
        font-size: 48px;
        text-shadow: 0 0 10px #ff0000;
      }

      .game-over p {
        font-size: 24px;
        margin-bottom: 100px;
      }

      .respawn-button {
        position: absolute;
        bottom: 40px;
        left: 50%;
        transform: translateX(-50%);
        padding: 15px 30px;
        font-size: 18px;
        background: linear-gradient(45deg, #ff4444, #b30000);
        border: 2px solid #ff8888;
        color: #ffffff;
      }

      .instructions {
        position: absolute;
        bottom: 10px;
        left: 10px;
        background: rgba(0, 0, 0, 0.8);
        padding: 10px;
        border-radius: 5px;
        border: 1px solid #00ff41;
        font-size: 12px;
      }

      .test-panel {
        position: absolute;
        bottom: 10px;
        right: 10px;
        background: rgba(0, 0, 0, 0.8);
        padding: 10px;
        border-radius: 5px;
        border: 1px solid #ffaa00;
        font-size: 10px;
        color: #ffaa00;
        max-width: 300px;
        max-height: 200px;
        overflow-y: auto;
        z-index: 1000; /* High z-index to ensure visibility */
      }

      .debug-panel {
        position: absolute;
        top: 10px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0, 0, 0, 0.8);
        padding: 10px;
        border-radius: 5px;
        border: 1px solid #ff00ff;
        font-size: 10px;
        color: #ff00ff;
        display: none;
      }

      .loading {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: #00ff00;
        font-size: 18px;
        z-index: 30;
        display: none;
      }

      .error-message {
        position: absolute;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(255, 0, 0, 0.8);
        color: white;
        padding: 10px 20px;
        border-radius: 5px;
        display: none;
        z-index: 25;
      }

      .success-message {
        position: absolute;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0, 255, 0, 0.8);
        color: black;
        padding: 10px 20px;
        border-radius: 5px;
        display: none;
        z-index: 25;
      }

      .controls-help {
        position: absolute;
        bottom: 50px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0, 0, 0, 0.8);
        padding: 15px;
        border-radius: 5px;
        border: 1px solid #00ff41;
        text-align: center;
        font-size: 12px;
        display: none;
      }

      .room-link-panel {
        position: absolute;
        top: 50px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0, 0, 0, 0.9);
        padding: 20px;
        border-radius: 10px;
        border: 2px solid #00ff41;
        text-align: center;
        z-index: 22;
        display: none;
        min-width: 500px;
      }

      .room-link-input {
        width: 100%;
        margin: 10px 0;
        padding: 8px;
        background: rgba(0, 0, 0, 0.7);
        border: 1px solid #00ff41;
        color: #00ff00;
        border-radius: 3px;
        font-family: inherit;
        font-size: 12px;
      }

      .realtime-test-popup-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 10000; /* Ensure it's on top */
      }

      .realtime-test-popup-content {
        background: #1a237e;
        border: 2px solid #00ff41;
        border-radius: 10px;
        padding: 20px;
        width: 90%;
        max-width: 600px;
        max-height: 80%;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
      }

      .realtime-test-results-list {
        flex-grow: 1;
        margin-top: 10px;
        padding-right: 10px;
        font-size: 12px;
        color: #00ff00;
      }

      .realtime-test-results-list div {
        margin-bottom: 2px;
      }

      .realtime-test-summary {
        margin-top: 15px;
        padding-top: 10px;
        border-top: 1px solid #004e92;
        font-size: 14px;
        color: #00ff00;
        text-align: right;
      }

      .realtime-test-popup-close-btn {
        margin-top: 20px;
        align-self: flex-end;
      }

      @media (max-width: 768px) {
        .join-form {
          width: 90%;
          padding: 20px;
        }

        .room-link-panel {
          width: 90%;
          min-width: auto;
        }

        .player-list {
          top: auto;
          bottom: 10px;
          right: 10px;
          font-size: 10px;
          min-width: 150px;
        }

        .test-panel {
          max-width: 200px;
          font-size: 8px;
        }
      }
    </style>
  </head>
  <body>
    <div class="game-container">
      <!-- 로딩 화면 -->
      <div class="loading" id="loading">🎮 게임 로딩 중...</div>

      <!-- 오류 메시지 -->
      <div class="error-message" id="errorMessage"></div>

      <!-- 성공 메시지 -->
      <div class="success-message" id="successMessage"></div>

      <!-- 게임 참가 폼 -->
      <div class="join-form" id="joinForm">
        <h2>몬스터를 피해라!</h2>
        <p>닉네임을 입력하세요</p>
        <input type="text" id="playerName" placeholder="닉네임" maxlength="15" />
        <br />
        <button id="joinGameBtn">게임 참가</button>
        <button id="runTestsBtn">🧪 테스트 실행</button>
        <button id="showControlsBtn">🎮 조작법</button>
        <div style="margin-top: 15px; font-size: 12px; color: #888">
          ✨ MVC 패턴으로 리팩토링된 게임<br />
          🧪 테스트 가능한 구조로 설계<br />
          🔗 BroadcastChannel API로 실시간 동기화<br />
          🎮 현재 상태: <span id="connectionStatus">연결 대기 중...</span>
        </div>
      </div>

      <!-- 게임 UI -->
      <div class="ui" id="gameUI" style="display: none">
        <div>⏱️ 생존 시간: <span id="timeDisplay">0</span>초</div>
        <div>👾 몬스터 수: <span id="observerCount">0</span></div>
        <div>🏆 내 점수: <span id="myScore">0</span></div>
        <div>📊 FPS: <span id="fpsDisplay">60</span></div>
        <div id="levelControl" style="display: none; margin-top: 10px">
          <div>🎚️ 레벨: <span id="levelDisplay">1</span></div>
          <button id="levelDownBtn">-</button>
          <button id="levelUpBtn">+</button>
        </div>
      </div>

      <!-- 플레이어 목록 -->
      <div class="player-list" id="playerList" style="display: none">
        <h3>👥 플레이어 목록</h3>
        <div id="players"></div>
      </div>

      <!-- 게임 캔버스 -->
      <canvas id="gameCanvas" style="display: none"></canvas>

      <!-- 게임 오버 화면 -->
      <div class="game-over" id="gameOver">
        <h2>💀 GAME OVER</h2>
        <p id="finalScore"></p>
        <button class="respawn-button" id="respawnBtn">🔄 다시 시작</button>
      </div>

      <!-- 게임 조작법 -->
      <div class="instructions" id="instructions" style="display: none">
        ⌨️ 화살표 키 또는 WASD로 이동 • 🔫 스페이스바로 총 발사 • 👾 몬스터를 피하세요! • 💥 다른 플레이어와 부딪히면
        기절!
      </div>

      <!-- 조작법 도움말 -->
      <div class="controls-help" id="controlsHelp">
        <h3>🎮 게임 조작법</h3>
        <p><strong>이동:</strong> ⬆️⬇️⬅️➡️ 화살표 키 또는 W A S D</p>
        <p><strong>공격:</strong> 🔫 스페이스바 (자동 조준)</p>
        <p><strong>목표:</strong> 👾 몬스터를 피하고 최대한 오래 생존하세요!</p>
        <p><strong>레벨업:</strong> 🏆 점수가 올라갈수록 더 강해집니다</p>
        <p><strong>멀티플레이어:</strong> 🔗 링크를 공유해서 친구들과 함께 플레이하세요</p>
        <br />
        <button id="hideControlsBtn">닫기</button>
      </div>

      <!-- 방 링크 공유 -->
      <div class="room-link-panel" id="roomLinkPanel">
        <h3>🔗 친구 초대하기</h3>
        <p>이 링크를 친구들에게 공유하세요:</p>
        <input type="text" class="room-link-input" id="roomLinkInput" readonly />
        <br />
        <button id="copyRoomLinkBtn">📋 링크 복사</button>
        <button id="hideRoomLinkBtn">닫기</button>
        <div style="margin-top: 15px; font-size: 10px; color: #888">
          💡 링크를 복사해서 친구들에게 보내주세요!<br />
          🌐 같은 브라우저에서 새 탭을 열어서 테스트할 수 있습니다.
        </div>
      </div>

      <!-- 리셋 버튼 -->
      <div
        id="resetContainer"
        style="position: absolute; top: 10px; left: 50%; transform: translateX(-50%); z-index: 20; display: none"
      >
        <button id="resetGameBtn">🔄 모든 몬스터 리셋</button>
      </div>

      <!-- 테스트 결과 패널 -->
      <div class="test-panel" id="testPanel" style="display: none">
        <h4>🧪 테스트 결과</h4>
        <div id="testResults"></div>
        <button
          id="hideTestPanelBtn"
          style="margin-top: 5px; font-size: 8px"
          onclick="window.game.view.hideTestPanel()"
        >
          닫기
        </button>
      </div>

      <!-- Realtime Test Popup -->
      <div class="realtime-test-popup-overlay" id="realtimeTestPopupOverlay" style="display: none">
        <div class="realtime-test-popup-content">
          <h3 style="color: #00ff00">🧪 실시간 테스트 결과</h3>
          <div id="realtimeTestResultsList" class="realtime-test-results-list">
            <!-- Realtime results will be appended here -->
          </div>
          <div class="realtime-test-summary" id="realtimeTestSummary"></div>
          <button id="closeRealtimeTestPopupBtn" class="realtime-test-popup-close-btn">닫기</button>
        </div>
      </div>

      <!-- 디버그 패널 -->
      <div class="debug-panel" id="debugPanel">
        <h4>🐛 디버그 정보</h4>
        <div id="debugInfo"></div>
      </div>
    </div>

    <!-- 게임 스크립트 (ES6 모듈) -->
    <script type="module">
      import { GameState } from './js/model.js';
      import { GameView } from './js/view.js';
      import { GameController } from './js/controller.js';
      import { NetworkService } from './js/network.js';
      import { TestFramework } from './js/test-framework.js';
      import { setupGameTests } from './js/tests.js';

      // 페이지 로드 완료 시 초기화
      document.addEventListener('DOMContentLoaded', () => {
        // 전역 게임 인스턴스들
        const gameState = new GameState();
        const gameView = new GameView();
        const networkService = new NetworkService();
        const testFramework = new TestFramework();
        const gameController = new GameController(gameState, gameView, networkService, testFramework);

        // 테스트 설정
        setupGameTests(testFramework);

        // FPS 카운터
        let lastFrameTime = Date.now();
        let frameCount = 0;
        let fps = 60;

        function updateFPS() {
          frameCount++;
          const now = Date.now();

          if (now - lastFrameTime >= 1000) {
            fps = Math.round((frameCount * 1000) / (now - lastFrameTime));
            frameCount = 0;
            lastFrameTime = now;

            const fpsDisplay = document.getElementById('fpsDisplay');
            if (fpsDisplay) {
              fpsDisplay.textContent = fps;
              fpsDisplay.style.color = fps < 30 ? '#ff4444' : fps < 50 ? '#ffaa00' : '#00ff00';
            }
          }
        }

        // 게임 루프에 FPS 카운터 추가
        const originalRender = gameView.render.bind(gameView);
        gameView.render = function (gameState) {
          updateFPS();
          return originalRender(gameState);
        };

        // 디버그 모드 토글 (Ctrl+D)
        let debugInterval = null;
        document.addEventListener('keydown', (e) => {
          if (e.ctrlKey && e.key === 'd') {
            gameState.debug = !gameState.debug;
            const debugPanel = document.getElementById('debugPanel');
            if (debugPanel) {
              debugPanel.style.display = gameState.debug ? 'block' : 'none';
            }

            if (gameState.debug) {
              if (debugInterval) clearInterval(debugInterval);
              debugInterval = setInterval(updateDebugInfo, 1000);
            } else {
              if (debugInterval) clearInterval(debugInterval);
            }

            e.preventDefault();
          }
        });

        function updateDebugInfo() {
          if (!gameState.debug) return;

          const debugInfo = document.getElementById('debugInfo');
          if (debugInfo) {
            const info = [
              `플레이어: ${gameState.players.size}`,
              `몬스터: ${gameState.monsters.length}`,
              `총알: ${gameState.bullets.length}`,
              `아이템: ${gameState.items.length}`,
              `FPS: ${fps}`,
              `호스트: ${gameState.isHost ? 'Yes' : 'No'}`,
              `연결: ${networkService.isConnected() ? 'Yes' : 'No'}`,
              `방 ID: ${gameState.roomId || 'None'}`,
            ];

            debugInfo.innerHTML = info.map((line) => `<div>${line}</div>`).join('');
          }
        }

        // 전역 접근을 위한 객체 노출 (디버깅용)
        window.game = {
          state: gameState,
          view: gameView,
          controller: gameController,
          network: networkService,
          tests: testFramework,
        };

        console.log('🎮 MVC 멀티플레이어 게임 초기화 완료');
        console.log('📝 사용 가능한 명령어:');
        console.log('  - window.game: 게임 객체 접근');
        console.log('  - Ctrl+D: 디버그 모드 토글');

        // URL에 방 ID가 있으면 자동으로 참가 모드로 전환
        const urlParams = new URLSearchParams(window.location.search);
        const roomId = urlParams.get('room');
        if (roomId) {
          const statusElement = document.getElementById('connectionStatus');
          if (statusElement) {
            statusElement.textContent = '방에 참가 대기 중...';
            statusElement.style.color = '#ffaa00';
          }
        }
      });
    </script>

    <noscript>
      <div
        style="
          position: fixed;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          background: rgba(255, 0, 0, 0.9);
          color: white;
          padding: 20px;
          border-radius: 10px;
          text-align: center;
        "
      >
        <h2>JavaScript가 필요합니다</h2>
        <p>이 게임을 플레이하려면 JavaScript를 활성화해주세요.</p>
      </div>
    </noscript>
  </body>
</html>
